@using iTuinBook.Models;
@model iTuinBook.Models.Pregunta

@{
    ViewBag.Title = "PL1_Pregunta";
    Layout = "~/Views/Shared/_LayoutNada.cshtml";
    DatosUsuario du = (DatosUsuario)ViewBag.DatosUsuario;
    ConfigModulo configModulo = (ConfigModulo)ViewBag.ConfigModulo;
    ConfigPregunta configPregunta = (ConfigPregunta)ViewBag.ConfigPregunta;
}

<div>

<div id=enunciado style="padding-left: 20px; padding-right: 20px;">
    @Html.Raw(Model.Enunciado)                        
</div>
     
<div id=alternativas style="padding-left: 20px; padding-right: 20px;">
    <ul>
    @foreach (Alternativa alt in Model.Alternativas)
    {
        @Html.RadioButtonFor(r => alt, alt.Opcion, new { @class="radio", @style="width:20px"}) @alt.Opcion <br />
    }
    </ul>
</div>

<div id="ayudas" style="visibility: hidden">
    <img id="btnFlotador" width="50" height="50" src="~/Content/Ayudas/ayuda_flotador.jpg" />
    <img id="btnPrismaticos" width="50" height="50" src="~/Content/Ayudas/ayuda_texto_1.png" />
    <img id="btnLupa" width="50" height="50" src="~/Content/Ayudas/ayuda_texto_2.png" />
</div>

   @Ajax.ActionLink(
    "Validar", 
    "PL1_Pregunta_Test_Validar", 
    "PL1_Experimentos",     
    new { GrupoID = du.GrupoID, ModuloID = du.ModuloID, PreguntaID = Model.PreguntaID, respuesta = "alter" },                
    new AjaxOptions { 
        UpdateTargetId = "pregunta",
        InsertionMode = System.Web.Mvc.Ajax.InsertionMode.Replace,  
        OnSuccess = "onSuccess"               
    }
)

    <button id="btnValidarTest">Validar</button>                       
</div> 

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        $(document).ready(function () {
            var timeStart = new Date();
            var timeFinish = new Date();

            $("#btnValidarTest").click(function () {
                var alter = "";

                $(":radio").each(function () {
                    if ($(this).is(":checked")) {
                        alter = $(this).val();

                        return false;
                    }
                });

                $.ajax({
                    cache: false,
                    url: "/PL1_Experimentos/PL1_Pregunta_Test_Validar", //url: '/iTuinBook/Validar',
                    type: 'POST',
                    data: { GrupoID: '@du.GrupoID', ModuloID: '@du.ModuloID', PreguntaID: '@Model.PreguntaID', respuesta: alter },
                    success: function (redirect) {
                        $.post(redirect.Url, function (partial) {

                            $('#pregunta').html(partial);
                        });
                        // data.redirect contains the string URL to redirect to
                        
                        //window.location.href = result.redirect;                        
                    },
                    error: function () {
                        alert("error");
                    }                    
                });
            });

            /**************************************/
            /**************************************/
            /******* CONFIGURACIÓN PREGUNTA *******/
            /**************************************/
            /**************************************/
            if ('@configPregunta.EnmascararEnunciado' == 'True') {
                $('#enunciado').addClass("difuminado");
                
                $('#enunciado').click(function () {                    
                    if ($('#enunciado').hasClass("difuminado")) {
                        $(":radio").attr("disabled", false);

                        $('#enunciado').removeClass("difuminado").addClass("no_difuminado");

                        if ('@configPregunta.EnmascararAlternativas' == 'True') {
                            if ($('#alternativas').hasClass("difuminado")) {
                                
                            }
                            else {
                                $('#alternativas').removeClass("no_difuminado").addClass("difuminado");

                                // Calcular tiempo de alternativa y enviar al servidor
                                timeFinish = jQuery.now();

                                var diff = timeFinish - timeStart;

                                $.ajax({
                                    url: "/PL1_Experimentos/RegistrarAccion",
                                    type: 'POST',
                                    data: { DatosUsuarioID: '@du.DatosUsuarioID', GrupoID: '@du.GrupoID', ModuloID: '@configModulo.ModuloID', TextoID: '@Model.Texto.TextoID', PreguntaID: '@Model.PreguntaID', CodeOP: 19, Param: diff.toString() },
                                    error: function () {
                                        alert("Error: Hubo un error con tu última acción.");
                                    }
                                });
                            }

                        }
                              
                        timeStart = jQuery.now();                        
                    }
                });               
            }

            if ('@configPregunta.EnmascararAlternativas' == 'True') {
                $('#alternativas').addClass("difuminado");

                $('#alternativas').click(function () {
                    if ($('#alternativas').hasClass("difuminado")) {
                        $('#alternativas').removeClass("difuminado").addClass("no_difuminado");

                        if ('@configPregunta.EnmascararEnunciado' == 'True') {
                            if ($('#enunciado').hasClass("difuminado")) {

                            }
                            else {
                                $('#enunciado').removeClass("no_difuminado").addClass("difuminado");
                                // Calcular tiempo de alternativa y enviar al servidor
                                timeFinish = jQuery.now();

                                var diff = timeFinish - timeStart;

                                $.ajax({
                                    url: "/PL0_Experimentos/RegistrarAccion",
                                    type: 'POST',
                                    data: { DatosUsuarioID: '@du.DatosUsuarioID', GrupoID: '@du.GrupoID', ModuloID: '@configModulo.ModuloID', TextoID: '@Model.Texto.TextoID', PreguntaID: '@Model.PreguntaID', CodeOP: 18, Param: diff.toString() },
                                    error: function () {
                                        alert("Error: Hubo un problema con tu última acción.");
                                    }
                                });
                            }
                        }

                        timeStart = jQuery.now();
                    }
                });
            }

            if ('@configPregunta.Ayuda' == 'True') {
                $('#ayudas').show();
                $('#ayudas').css("visibility", "visible")
            }
            else {
                $('#ayudas').hide();
                $('#ayudas').css("visibility", "hidden")
            }

            /**************************************/
            /**************************************/
            


        });
    </script>
}
